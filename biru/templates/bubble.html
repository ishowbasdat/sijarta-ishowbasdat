<div class="top-0 py-4 mt-4 font-medium text-gray-700 shadow-sm">
    Testimoni
</div>
<div id="testimonial-container" class="bg-white rounded-lg shadow-sm h-full sm:h-full">
    <div id="testimonial-placeholder" class="p-4 text-gray-600 text-center">
        Pilih pekerja untuk melihat testimoni
    </div>
</div>

<script>
    function deleteTestimonial(orderId, testimonialDate) {
        if (!confirm('Apakah Anda yakin ingin menghapus testimoni ini?')) {
            return;
        }

        fetch('/biru/api/delete_testimoni/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                order_id: orderId,
                testimonial_date: testimonialDate
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal menghapus testimoni');
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            const currentWorkerId = document.querySelector('.worker-box.active')?.getAttribute('data-worker-id');
            if (currentWorkerId) {
                fetchWorkerTestimonials(currentWorkerId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Gagal menghapus testimoni. Silakan coba lagi.');
        });
    }

    function fetchWorkerTestimonials(workerId, subkategoriId) {        
        const testimonialContainer = document.getElementById('testimonial-container');

        testimonialContainer.innerHTML = `
            <div class="p-4 text-gray-600 text-center">
                Memuat testimoni...
            </div>
        `;

        fetch(`/biru/api/get_testimoni/${subkategoriId}/${workerId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Gagal memuat testimoni');
                }
                return response.json();
            })
            .then(data => {
                testimonialContainer.innerHTML = '';

                if (data.testimonials && data.testimonials.length > 0) {
                    data.testimonials.forEach(testi => {
                        const testiElement = document.createElement('div');
                        testiElement.classList.add(
                            'p-4', 
                            'text-gray-800', 
                            'border-b', 
                            'border-gray-200',
                            'relative'
                        );
                        const starRating = '‚òÖ'.repeat(testi.rating) + '‚òÜ'.repeat(5 - testi.rating);
                        
                        testiElement.innerHTML = `
                            <div class="relative">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-yellow-500">
                                        ${starRating}
                                    </div>
                                </div>
                                <p class="mb-2 font-medium">Oleh: ${testi.author}</p>
                                <p>${testi.comment}</p>
                                <span class="text-sm text-gray-500 absolute bottom-0 right-0">
                                    ${testi.date}
                                </span>
                                ${testi.is_own_testimonial ? `
                                    <button onclick="deleteTestimonial('${testi.order_id}', '${testi.date}')" 
                                        class="absolute top-2 right-2 text-red-500 hover:text-red-700">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                            </div>
                        `;

                        testimonialContainer.appendChild(testiElement);
                    });
                } else {
                    testimonialContainer.innerHTML = `
                        <div class="p-4 text-gray-600 text-center">
                            Belum ada testimoni untuk pekerja ini pada subkategori ini.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                testimonialContainer.innerHTML = `
                    <div class="p-4 text-red-600 text-center">
                        Gagal memuat testimoni. Silakan coba lagi.
                    </div>
                `;
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const workerBoxes = document.querySelectorAll('.worker-box');
        
        workerBoxes.forEach(box => {
            box.addEventListener('click', () => {
                workerBoxes.forEach(b => b.classList.remove('active'));
                box.classList.add('active');

                const workerId = box.getAttribute('data-worker-id');
                const subkategoriId = box.getAttribute('data-subkategori-id');
                if (workerId) {
                    fetchWorkerTestimonials(workerId, subkategoriId);
                }
            });
        });
    });
</script>